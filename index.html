<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>pcfsearch</title>
<style>

.hbox {
    display: flex;
    align-items: stretch;
}

.vbox {
    display: flex;
    flex-direction: column;
    align-items: stretch;
}

.window {
    display: flex;
    flex-direction: column;
    margin: 1px;
}

.titlebar {
    display: flex;
    background: black;
    color: white;
    padding: 5px;
    font-weight: bold;
}

.title {
    flex-grow: 1;
    text-align: center;
}

.content {
    flex-basis: 0;
    flex-grow: 1;
    background: blue;
    overflow: auto;
}

ul#dropdown_list {
    list-style-type: none;
    position: absolute;
    display: none;
    z-index: 1;
    background: gray;
    margin: 0;
    padding: 0;
}

ul#dropdown_list li {
    padding: 6px;
    cursor: default;
    font-family: serif;
    font-size: 16px;
    width: 14em;
}

ul#dropdown_list li:hover {
    background: blue;
}


#dropdown:hover ul#dropdown_list {
    display: block;
}

a {
    text-decoration: none;
    color: white;
    padding: 6px;
    cursor: default;
}

a:hover,a.selected {
    background: gray;
}

button#dropdown_header {
    background: black;
    border: 0px;
    padding: 6px 6px 5px;
    color: white;
    font-family: serif;
    font-size: 16px;
    width:14em;
}

table {
    margin: 0px auto;
}

th {
    background: #ccc;
}

tr.selected td {
    background: yellow;
}

tr.editable td {
    background: green;
}

td {
    background: white;
    cursor: default;
}

button.icon {
    padding: 0px;
    border-radius: initial;
    width: 20px;
}

button.icon:hover {
    background: gray;
}

button.option {
    padding: 4px 6px;
    border-radius: 3px 3px 3px 3px;
    font-family: Ubuntu;
    font-size: 14px;
    border: 1px outset #aaaaaa;
    color: black;
    cursor: inherit;
}

button.option.def {
    padding: 1px 2px;
    background: linear-gradient(to top,yellow,white);
    color: red;
}

button.option.all {
    padding: 1px 2px;
    background: linear-gradient(to top,yellow,white);
}

button.option.some {
    padding: 1px 2px;
    background: linear-gradient(to top,cyan,white);
}

button.option.none {
    padding: 1px 2px;
    background: linear-gradient(to top,rgb(0,210,210),rgb(210,210,210));
    color: gray;
}

button.option.attribute:hover, button.option.role:hover {
    border: 1px solid black;
}

summary {
    background: linear-gradient(to top,cyan,gray);
}

circle,rect {
    fill: white;
    stroke: black;
}

rect.marked {
    fill: yellow;
    stroke: black;
}

rect:hover {
    stroke: red;
}

text {
    pointer-events: none;
}

.table_box_content {
    background: red;
}

.editable .table_box_content {
    background: green;
}

.options {
    display: flex;
    flex-wrap: wrap;
}

.label {
    font-family: Ubuntu;
    font-size: 14px;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js">
</script>
<script>

queue = [];
edit_mode = false;
box_edit_mode = false;

function abspath(url) {

    if(!url.endsWith("/")) {
        url += "/";
    }

    if(url.startsWith("/")) {
        return url;
    }

    current_url = window.location.pathname;
    if(!current_url.endsWith("/")) {
        current_url += "/";
    }

    return current_url + url
}

function Point(x,y) {
    this.x = x;
    this.y = y;
}

function Node(sort) {
    this.sort = sort;
    this.def = {};
    this.marked = false;
    this.corefs = {};
    this.point = null;
}

function Graph() {
    this.nodes = {};
    this.nextId = 1;
    this.ax = 10;
    this.ay = 10;
    this.radius = Math.sqrt(4*(this.ax)*(this.ay)/Math.PI); // give circle same area as rectangle for better looks
}

Graph.prototype = {
    add_node: function(sort) {
        var nodeId = "t"+this.nextId++;
        this.nodes[nodeId] = new Node(sort);
        return nodeId;
    },

    add_rnode: function(nodeIds,m) {
        var relId = nodeIds.join("#");
        var sort = nodeIds.map(function(nodeId){ return this.nodes[nodeId].sort },this).join("#");

        var rnode = new Node(sort);
        this.nodes[relId] = rnode;
        this.add_attribute(relId,m);

        return relId;
    },

    remove_rnode: function(nodeId) {
        delete this.nodes[nodeId];
        this.cleanup();
    },

    add_attribute: function(nodeId,m) {
        var prefix = m.split(":")[0];
        var name = m.split(":")[1];
        var def = this.nodes[nodeId].def;

        if(!(prefix in def)) {
            def[prefix] = {};
        }

        def[prefix][name] = null;
    },

    remove_attribute: function(nodeId,m) {
        var prefix = m.split(":")[0];
        var name = m.split(":")[1];
        var def = this.nodes[nodeId].def;

        delete def[prefix][name];
        if(Object.keys(def[prefix]).length == 0) {
            delete def[prefix];
        }

        if(this.is_rnode(nodeId) && Object.keys(def).length == 0) {
            this.remove_rnode(nodeId);
        }
    },

    set_mark: function(nodeId,marked) {
        this.nodes[nodeId].marked = marked;
        if(!marked) { this.cleanup(); }
    },

    add_coreference: function(nodeId1,nodeId2) {
        this.nodes[nodeId1].corefs[nodeId2] = true;
        this.nodes[nodeId2].corefs[nodeId1] = true;
    },

    remove_coreference: function(nodeId1,nodeId2) {
        delete this.nodes[nodeId1].corefs[nodeId2];
        delete this.nodes[nodeId2].corefs[nodeId1];
        this.cleanup();
    },

    set_pos: function(nodeId,x,y) {
        var node = this.nodes[nodeId];
        node.point = new Point(x,y);
    },

    set_apos: function(nodeId,m,x,y) {
        var prefix = m.split(":")[0];
        var name = m.split(":")[1];
        var def = this.nodes[nodeId].def;
        def[prefix][name] = new Point(x,y);
    },

    is_rnode: function(nodeId) {
        return typeof(nodeId)==="string" && nodeId.includes("#");
    },

    is_marked: function(nodeId) {
        return this.nodes[nodeId].marked;
    },

    cleanup: function() {
        var rep = {};
        var rnodes = [];

        for(var nodeId in this.nodes) {
            if(this.is_rnode(nodeId)) {
                rnodes.push(nodeId);
            } else {
                rep[nodeId] = nodeId;
            }
        }

        for(var nodeId in this.nodes) {
            if(!(this.is_rnode(nodeId))) {
                var node = this.nodes[nodeId];
                var eq_reps = $.map(Object.keys(node.corefs),function(n) { return rep[n] });
                eq_reps.push(rep[nodeId]);
                var chosen_rep = eq_reps[0];
                for(var j=1; j<eq_reps.length; ++j) {
                    if(eq_reps[j] < chosen_rep) {
                        chosen_rep = eq_reps[j];
                    }
                }
                for(var otherId in rep) {
                    if($.inArray(rep[otherId],eq_reps) != -1) {
                        rep[otherId] = chosen_rep;
                    }
                }
            }
        }

        for(var i=0; i<rnodes.length; ++i) {
            var rkey = rnodes[i];
            var eq_reps = $.map(rkey.split("#"),function(nodeId){ return rep[nodeId] });
            var chosen_rep = eq_reps[0];
            for(var j=1; j<eq_reps.length; ++j) {
                if(eq_reps[j] < chosen_rep) {
                    chosen_rep = eq_reps[j];
                }
            }
            for(var nodeId in rep) {
                if($.inArray(rep[nodeId],eq_reps) != -1) {
                    rep[nodeId] = chosen_rep;
                }
            }
        }

        var components = {};
        for(var nodeId in rep) {
            if(rep[nodeId] in components) {
                components[rep[nodeId]].push(nodeId);
            } else {
                components[rep[nodeId]] = [nodeId];
            }
        }

        for(var key in components) {
            var comp = components[key];
            var clean=true;
            for(var i=0; i<comp.length; ++i) {
                var node = this.nodes[comp[i]];
                if(node.marked) {
                    clean=false;
                }
            }

            if(clean) {
                for(var i=0; i<comp.length; ++i) {
                    var nodeId = comp[i];
                    delete this.nodes[nodeId];
                }
            }
        }

        var invalidIds = {};
        for(var k=0; k<rnodes.length; ++k) {
            var rkey = rnodes[k];
            var nodeIds = rkey.split("#");
            for(var i=0; i<nodeIds.length; ++i) {
                var nodeId = nodeIds[i];
                if(!(nodeId in this.nodes)) {
                    invalidIds[rkey] = true;
                }
            }
        }
        for(var rnodeId in invalidIds) {
            delete this.nodes[rnodeId];
        }
    },

    draw: function() {
        var group = document.createElementNS("http://www.w3.org/2000/svg","g");
        var $group = $(group);

        for(var key in this.nodes) {
            var node = this.nodes[key];
            var p = node.point;

            if(p !== null) {
                if(this.is_rnode(key)) { // relation node
                    $group.prepend(this.svg_rnode(p.x,p.y));

                    var neighbors = key.split("#");
                    for(var i=0;i<neighbors.length;++i) {
                        var q = this.nodes[neighbors[i]].point;
                        if(q !== null) {
                            var e = this.compute_edge(p.x,p.y,q.x,q.y);
                            if(e !== null) {
                                $group.prepend(this.svg_edge(e[0].x,e[0].y,e[2].x,e[2].y));
                                $group.prepend(this.svg_label(e[1].x,e[1].y,i+1));

                            }
                        }
                    }
                } else { // object node
                    $group.prepend(this.svg_label(p.x,p.y,key.replace("t","#")));
                    $group.prepend(this.svg_node(p.x,p.y,key,node.marked));
                    $group.prepend(this.svg_label(p.x,p.y-(this.ay)-7,node.sort));

                    for(var key2 in node.corefs) {
                        if(key<key2) {
                            var p2 = this.nodes[key2].point;
                            $group.append(this.svg_link(p.x,p.y,p2.x,p2.y));
                        }
                    }
                }
            }

            for(var prefix in node.def) {
                for(var name in node.def[prefix]) {
                    var q = node.def[prefix][name];
                    if(q !== null) {
                        $group.prepend(this.svg_label(q.x,q.y,name));
                    }
                }
            }
        }

        $("svg > g").replaceWith($group);
        
    },

    compute_edge: function(rx,ry,x,y) {
        // (dx,dy) = vector from rnode to node
        var dx=x-rx, dy=y-ry;

        // (rx,ry) + s*(dx,dy) = intersection of line with sphere (only for s<1)
        var length = Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));
        var s = (this.radius<length) ? this.radius/length : 1;

        // (rx,ry) + (1-t)*(dx,dy) = intersection of line with rectangle side (only for t<1)
        var tx=1,ty=1;
        if(Math.abs(dx) > this.ax) { tx = this.ax/Math.abs(dx); }
        if(Math.abs(dy) > this.ay) { ty = this.ay/Math.abs(dy); }
        var t=Math.min(tx,ty);

        // if rnode and node don't overlap, return endpoints of the edge
        if(s<1 && t<1 && s<(1-t)) {
            var m = 0.5*(s+1-t);
            return [new Point(rx+s*dx,ry+s*dy), new Point(rx+m*dx,ry+m*dy), new Point(rx+(1-t)*dx,ry+(1-t)*dy)];
        } else {
            return null;
        }
    },

    svg_node: function(x,y,id,marked) {
        var node = document.createElementNS("http://www.w3.org/2000/svg","rect");
        var $node = $(node).attr({"data-id":id,"x":x-this.ax,"y":y-this.ay,"width":2*this.ax,"height":2*this.ay})
                           .on("click",toggle_mark);
        if(marked) {
            $node.addClass("marked");
        }
        return $node;
    },

    svg_label: function(x,y,text) {
        var label = document.createElementNS("http://www.w3.org/2000/svg","text");
        var $label = $(label).attr({"x":x,"y":y,"text-anchor":"middle","dominant-baseline":"central","font-family":"Ubuntu","font-size":"14.00"})
                             .text(text);
        return $label;
    },

    svg_rnode: function(x,y) {
        var rnode = document.createElementNS("http://www.w3.org/2000/svg","circle");
        var $rnode = $(rnode).attr({"cx":x,"cy":y,"r":this.radius});
        return $rnode;
    },

    svg_edge: function(x1,y1,x2,y2) {
        cmd = "M" + x1 + "," + y1 + "L" + x2 + "," + y2;
        var path = document.createElementNS("http://www.w3.org/2000/svg","path");
        var $path = $(path).attr({"fill":"none","stroke":"black","d":cmd});
        return $path;
    },

    svg_link: function(x1,y1,x2,y2) {
        cmd = "M" + x1 + "," + y1 + "L" + x2 + "," + y2;
        var path = document.createElementNS("http://www.w3.org/2000/svg","path");
        var $path = $(path).attr({"fill":"none","stroke":"red","stroke-dasharray":5,"d":cmd});
        return $path;
    },

    toJSON: function() {
        var copy = {};
        for(var nodeId in this.nodes) {
            var node = this.nodes[nodeId];
            var atts = {};
            for(var prefix in node.def) {
                atts[prefix] = Object.keys(node.def[prefix]);
            }

            copy[nodeId] = {'sort':node.sort, 'def':atts, 'marked':node.marked, 'corefs':Object.keys(node.corefs) };
        }
        return copy;
    }
};

graph = new Graph();

function create_node() {

    if(queue.length>0) { return; }

    var sort = $(this).text();
    var id = graph.add_node(sort);
    graph.set_mark(id,true);

    var action = $.Deferred();
    action.done(function(x,y){
        graph.set_pos(id,x,y);
    });

    queue.push(action);
    $('html').css('cursor','copy');
}

function create_rnode() {

    if(queue.length>0) { return; }

    var $this = $(this);
    var obj = $this.data("obj");
    var m = $this.data("attr");
    var sort = $this.data("sort");
    var role = $this.data("role");

    var nodes = [];
    for(var i=0; i<sort.length; ++i) {

        if(i+1 !== role) {
            var nodeId = graph.add_node(sort[i]);
            nodes.push(nodeId);
            var action = $.Deferred();
            action.done(function(j){
                return function(x,y) {
                    graph.set_pos(j,x,y);
                }
            }(nodeId));
            queue.push(action);

        } else {
            nodes.push(obj);
        }
    }

    var relId = graph.add_rnode(nodes,m);

    var action = $.Deferred();
    action.done(function(rx,ry){
        graph.set_pos(relId,rx,ry);
        graph.set_apos(relId,m,rx,ry-graph.ay-7);

    });
    queue.unshift(action);

    $('html').css('cursor','copy');
}

function toggle_attribute() {

    if(queue.length>0) { return; }

    var $this = $(this);
    var nodeId = $this.data("obj");
    var m = $this.data("attr");

    if($this.hasClass("all") || $this.hasClass("some")) {
        graph.add_attribute(nodeId,m);

        var action = $.Deferred();
        action.done(function(x,y) {
            graph.set_apos(nodeId,m,x,y);
        });

        queue.push(action);
        $('html').css('cursor','copy');

    } else if($this.hasClass("def")) {
        graph.remove_attribute(nodeId,m);
        graph.draw();
        solve();
    }
}

function toggle_mark() {
    if(queue.length>0) { return; }

    var $this = $(this);
    var nodeId = $this.data("id");
    var marked = graph.is_marked(nodeId);
    graph.set_mark(nodeId,!marked);
    graph.draw();
    solve();

}

function toggle_coreference() {
    if(queue.length>0) { return; }

    var $this = $(this);
    var nodeId1 = $this.data("lhs");
    var nodeId2 = $this.data("rhs");

    if($this.hasClass("all") || $this.hasClass("some")) {
        graph.add_coreference(nodeId1,nodeId2);

    } else if($this.hasClass("def")) {
        graph.remove_coreference(nodeId1,nodeId2);
    }
    graph.draw();
    solve();

}

function get_scales() {
    $.ajax({
        url: abspath("get_scales"),
        dataType: "json"
    }).done(function(data,status,jqxhr) {

        var tbody = $("<tbody>").attr("id","scales");
        $.each(data,function(index,row){
            var id = row[0];
            var name = row[1];
            var arity = row[2];
            var tr = $("<tr>").attr("data-id",id)
                              .on("click",select_scale)
                              .on("dblclick",edit_scale);
            var td1 = $("<td>").text(name);
            var td2 = $("<td>").text(arity);
            tr.append(td1).append(td2);
            tbody.append(tr);
        });
        $("tbody#scales").replaceWith(tbody);
        tbody.find("tr:first").trigger("click");
    });
}

function select_scale() {

    if(edit_mode) { return; }

    var $this = $(this);
    if($this.hasClass("selected")) {
        return;
    } else {
        $this.siblings().removeClass("selected");
        $this.addClass("selected");
    }

    var id = $(this).data("id");
    $.ajax({
        url: abspath("describe_scale"),
        data: { "id":id },
        dataType: "json",
    }).done(function(data,status,jqxhr) {

        var $tbody = $("<tbody>").attr("id","attributes")
                                 .attr("data-scale",id);
        $.each(data,function(index,row){
            var tr = $("<tr>").on("click",select_attribute)
                              .on("dblclick",edit_attribute)
                              .attr("data-id",row[0]);
            var td1 = $("<td>").text(row[1]);
            var td2 = $("<td>").text(row[2]);
            tr.append(td1).append(td2);
            $tbody.append(tr);
        });
        $("tbody#attributes").replaceWith($tbody);
    });
}

function select_attribute() {

    if(edit_mode) { return; }

    var $this = $(this);
    if($this.hasClass("selected")) {
        $this.removeClass("selected");
    } else {
        $this.siblings().removeClass("selected");
        $this.addClass("selected");
    }
}

function edit_scale() {

    var $this = $(this);
    var id = $this.data("id");
    if($this.hasClass("editable")) {

        var row = $this.find("td").map(function(index,td) {
            return $(td).text().trim();
        }).get();

        var name = row[0];
        var arity = row[1];

        if(name == "" || !(/^[1-9]$/.test(arity))) {
            return;
        }

        $this.find("td").attr("contenteditable","false");
        $.ajax({
            url: abspath("write_scale"),
            type: "POST",
            data: JSON.stringify({
                "id": id,
                "name": name,
                "arity": arity,
            }),
            contentType: "application/json",
        }).done(function(insertId,status,jqxhr) {
            if(id == "") { $this.data("id",insertId); }
            $this.removeClass("editable");
            edit_mode = false;
            $this.trigger("click");
        });
    } else if(edit_mode) {
        return;
    } else {
        edit_mode = true;
        $this.find("td").attr("contenteditable","true");
        $this.addClass("editable");
    }
}

function delete_scale() {

    if(edit_mode) { return; }

    var $this = $(this);
    var id = $("tbody#scales tr.selected").first().data("id");

    $.ajax({
        url: abspath("delete_scale"),
        type: "POST",
        data: JSON.stringify(id),
        contentType: "application/json",
    }).done(function(data,status,jqxhr) {
        get_scales();
    });
}

function delete_binding() {

    if(edit_mode) { return; }

    var $this = $(this);
    var id = $("tbody#bindings tr.selected").first().data("id");

    $.ajax({
        url: abspath("delete_binding"),
        type: "POST",
        data: JSON.stringify(id),
        contentType: "application/json",
    }).done(function(data,status,jqxhr) {
        get_bindings();
    });
}

function delete_attribute() {

    if(edit_mode) { return; }

    var $this = $(this);
    var $row = $("tbody#attributes tr.selected").first();

    if($row.length != 0) {
        var id = $row.data("id");
        $.ajax({
            url: abspath("delete_attribute"),
            type: "POST",
            data: JSON.stringify(id),
            contentType: "application/json",
        }).done(function(data,status,jqxhr) {
            $row.remove();
        });
    }
}

function create_attribute() {

    if(edit_mode) { return; }

    var tr = $("<tr>").addClass("editable");
    var td1 = $("<td>").attr("contenteditable","true");
    var td2 = $("<td>").attr("contenteditable","true");
    tr.append(td1)
      .append(td2)
      .on("click",select_attribute)
      .on("dblclick",edit_attribute)
      .attr("data-id","");
    var tbody = $("tbody#attributes")
    tbody.append(tr);
    tr.find("td:first").focus()
}

function edit_attribute() {

    var $this = $(this);
    var id = $this.data("id");
    var scaleId = $this.parent("tbody").data("scale");

    if($this.hasClass("editable")) {

        var row = $this.find("td").map(function(index,td) {
            return $(td).text().trim();
        }).get();

        var name = row[0];
        var sqldef = row[1];

        if(name == "" || sqldef == "") {
            return;
        }

        $this.find("td").attr("contenteditable","false");
        $.ajax({
            url: abspath("write_attribute"),
            data: {
                "id": id,
                "scale": scaleId,
                "name": name,
                "sqldef": sqldef,
            },
        }).done(function(insertId,status,jqxhr) {
            if(id == "") { $this.data("id",insertId); }
            $this.removeClass("editable");
            edit_mode = false;
        });
    } else if(edit_mode) {
        return;
    } else {
        edit_mode = true;
        $this.find("td").attr("contenteditable","true");
        $this.addClass("editable");
    }
}

function get_bindings() {
    $.ajax({
        url: abspath("get_bindings"),
        dataType: "json"
    }).done(function(data,status,jqxhr){

        var tbody = $("<tbody>").attr("id","bindings");
        $.each(data,function(index,row) {
            var id = row[0];
            var name = row[1];
            var host = row[2];
            var database = row[3];

            var tr = $("<tr>").attr("data-id",id)
                              .on("click",select_binding)
                              .on("dblclick",edit_binding);
            var td1 = $("<td>").text(host);
            var td2 = $("<td>").text(database);
            var td3 = $("<td>").text(name);
            tr.append(td1).append(td2).append(td3);
            tbody.append(tr);
        });
        $("tbody#bindings").replaceWith(tbody);
        tbody.find("tr:first").trigger("click");
    });
}

function select_binding() {

    if(edit_mode) { return; }

    var $this = $(this);
    var id = $this.data("id");

    if($this.hasClass("selected")) {
       return;
    } else {
        $this.siblings().removeClass("selected");
        $("#bound_scales").data("binding",id)
                          .empty();
        $this.addClass("selected");
    }

    $.ajax({
        url: abspath("describe_binding"),
        data: { "id":id },
        dataType: "json",
    }).done(function(data,status,jqxhr) {

        $.each(data,function(boundScaleId,boundScale) {
            var html = $("template#table_box").html();
            var box = $(html);
            box.on("dblclick",edit_binding_box)
               .attr("data-id",boundScaleId)
               .attr("data-scale",boundScale["scale"])
               .find(".title")
               .text(boundScale["name"]);
            box.find(".js-delete_binding_box").on("click",delete_binding_box);
            tbody = box.find("tbody");
            $.each(boundScale["bindings"],function(index,pair) {
                var tr = $("<tr>");
                var td1 = $("<td>").text(pair[0]);
                var td2 = $("<td>").text(pair[1]);
                tr.append(td1).append(td2);
                tbody.append(tr);
            });
            $("#bound_scales").append(box);
        });
    });

    var row = $this.find("td").map(function(index,td) {
        return $(td).text().trim();
    }).get();

    var host = row[0];
    var database = row[1];

    var tbody2 = $("<tbody>").attr("id","columns");
    $("tbody#columns").replaceWith(tbody2);

    $.ajax({
        url: abspath("get_columns"),
        data: {
            "binding": id,
            "host": host,
            "database": database,
        },
        dataType: "json",
    }).done(function(data,status,jqxhr) {

        $.each(data,function(index,row) {
            var table_name = row[0];
            var column_name = row[1];
            var output_column = row[2];

            var tr = $("<tr>").on("click",select_column);
            var td1 = $("<td>").text(table_name);
            var td2 = $("<td>").text(column_name);
            tr.append(td1).append(td2);
            if(output_column) {
                tr.addClass("selected");
            }

            tbody2.append(tr);
        });
    });
}

function create_scale() {

    if(edit_mode) { return; }

    var tr = $("<tr>");
    var td1 = $("<td>").attr("contenteditable","true");
    var td2 = $("<td>").attr("contenteditable","true");

    tr.append(td1)
      .append(td2)
      .on("click",select_scale)
      .on("dblclick",edit_scale)
      .attr("data-id","");

    var tbody = $("tbody#scales")
    tbody.append(tr);
    tr.siblings().removeClass("selected");

    var tbody2 = $("<tbody>").attr("id","attributes")
                             .attr("data-scale","");
    $("tbody#attributes").replaceWith(tbody2);

    tr.trigger("dblclick");
    tr.find("td:first").focus();
}

function create_binding() {

    if(edit_mode) { return; }

    var tr = $("<tr>");
    var td1 = $("<td>").attr("contenteditable","true");
    var td2 = $("<td>").attr("contenteditable","true");
    var td3 = $("<td>").attr("contenteditable","true");

    tr.append(td1)
      .append(td2)
      .append(td3)
      .attr("data-id","")
      .on("click",select_binding)
      .on("dblclick",edit_binding);

    var tbody = $("tbody#bindings")
    tbody.append(tr);
    tr.siblings().removeClass("selected");

    var tbody2 = $("<tbody>").attr("id","columns");
    $("tbody#columns").replaceWith(tbody2);

    $("#bound_scales").data("binding","")
                      .empty();

    tr.trigger("dblclick");
    tr.find("td:first").focus();
}

function edit_binding() {

    var $this = $(this);
    var id = $this.data("id");
    if($this.hasClass("editable")) {

        var row = $this.find("td").map(function(index,td) {
            return $(td).text().trim();
        }).get();

        var host = row[0];
        var database = row[1];
        var binding = row[2];

        if(host == "" || database == "" || row == "") {
            return;
        }

        $this.find("td").attr("contenteditable","false");
        $.ajax({
            url: abspath("write_binding"),
            data: {
                "id": id,
                "name": binding,
                "host": host,
                "database": database,
            },
        }).done(function(insertId,status,jqxhr) {
            if(id == "") { $this.data("id",insertId); }
            $this.removeClass("editable");
            edit_mode = false;
            $this.trigger("click");
        });
    } else if(edit_mode) {
        return;
    } else {
        edit_mode = true;
        $this.addClass("editable");
        $this.find("td").attr("contenteditable","true");
    }
}

function create_binding_box() {

    if(box_edit_mode) { return; }

    var $this = $(this);
    var scaleId = $this.data("id");
    var arity = $this.data("arity");

    var html = $("template#table_box").html();
    var $box = $(html);
    var $titlebar = $box.find(".title")
                        .attr("contenteditable","true");
    var $tbody = $box.find("tbody");

    $box.attr("data-id","")
        .attr("data-scale",scaleId)
        .on("dblclick",edit_binding_box)
        .find(".js-delete_binding_box").on("click",delete_binding_box)

    for(var i=0;i<arity;++i) {
        var tr = $("<tr>");
        var td1 = $("<td>").text(i);
        var td2 = $("<td>").text("");
        tr.append(td1).append(td2);
        $tbody.append(tr);
    }
    $("#bound_scales").prepend($box);
    $box.trigger("dblclick")
}

function edit_binding_box() {

    var $this = $(this);
    var $box = $this.closest(".table_box");
    var $frame = $this.closest("#bound_scales");
    var $titlebar = $box.find(".title");
    var $tbody = $box.find("tbody");

    var id = $box.data("id");
    var scaleId = $box.data("scale");
    var bindingId = $frame.data("binding");

    if($box.hasClass("editable")) {
        var name = $titlebar.text().trim();
        if(name == "") { return; }
        var bindings = {};
        $tbody.find("tr").each(function(i,tr) {
            row = $(tr).find("td").map(function(j,td) {
                    return $(td).text().trim();
                }).get();
            bindings[row[0]] = row[1];
        });

        for(var arg in bindings) {
            if(bindings[arg] == "") { return; }
        }

        $titlebar.attr("contenteditable","false");
        $.ajax({
            url: abspath("write_bound_scale"),
            type: "POST",
            data: JSON.stringify({
                "id": id,
                "name": name,
                "scaleId": scaleId,
                "bindingId": bindingId,
                "bindings": bindings,
            }),
            contentType: "application/json",
        }).done(function(insertId,status,jqxhr) {
            if(id == "") { $this.data("id",insertId); }
            $box.removeClass("editable");
            box_edit_mode = false;
        });
    } else if(box_edit_mode) {
        return;
    } else {
        box_edit_mode = true;
        $box.addClass("editable");
        $titlebar.attr("contenteditable","true");
    }
}

function delete_binding_box() {

    if(box_edit_mode) { return; }

    var $this = $(this);
    var $box = $this.closest(".table_box");
    var id = $box.data("id");

    $.ajax({
        url: abspath("delete_bound_scale"),
        type: "POST",
        data: JSON.stringify(id),
        contentType: "application/json",
    }).done(function(data,status,jqxhr) {
        $box.remove()
    });
}

function select_column() {
    var $this = $(this);

    var row = $this.find("td").map(function(index,td) {
        return $(td).text().trim();
    }).get();

    var bindingId = $("#bound_scales").data("binding");
    var table = row[0];
    var column = row[1];

    if(box_edit_mode) {
        $("#bound_scales .editable tbody td:empty").first().text(table+"."+column)
    } else {
        if($this.hasClass("selected")) {
            $.ajax({
                url: abspath("remove_output_column"),
                type: "POST",
                data: JSON.stringify({
                    "binding": bindingId,
                    "table": table,
                    "column": column,
                }),
                contentType: "application/json",
            }).done(function(data,status,jqxhr) {
                $this.removeClass("selected");
            });
        } else {
            $.ajax({
                url: abspath("add_output_column"),
                type: "POST",
                data: JSON.stringify({
                    "binding": bindingId,
                    "table": table,
                    "column": column,
                }),
                contentType: "application/json",
            }).done(function(data,status,jqxhr) {
                $this.addClass("selected");
            });
        }
    }
}

function get_scales_2() {

    $.ajax({
        url: abspath("get_scales"),
        dataType: "json",
    }).done(function(data,status,jqxhr) {

        var tbody = $("<tbody>").attr("id","scales");
        $.each(data,function(index,row){
            var id = row[0];
            var name = row[1];
            var arity = row[2];
            var tr = $("<tr>").attr("data-id",id)
                              .attr("data-arity",arity)
                              .on("click",create_binding_box);
            var td1 = $("<td>").text(name);
            var td2 = $("<td>").text(arity);
            tr.append(td1).append(td2);
            tbody.append(tr);
        });
        $("tbody#scales").replaceWith(tbody);
    });
}

function select_dropdown() {
    $this = $(this);
    var id = $this.data("id");
    var name = $this.text();
    $dropdown_header = $("button#dropdown_header");
    $dropdown_header.html(name+" &#x25bc;").data("id",id);
}

function get_sorts() {
    $.ajax({
        url: abspath("get_sorts"),
        data: { "binding": $("button#dropdown_header").data("id") },
        dataType: "json",
    }).done(function(data,status,jqxhr) {

        var details = $("<details>").prop("open",true);
        $("<summary>").text("Sorts").appendTo(details);
        var div = $("<div>").addClass("options");
        $.each(data,function(index,sort){
            $("<button>").addClass("option").addClass("sort").text(sort).on("click",create_node).appendTo(div);
        });
        details.append(div);
        $("#sortsView").prepend(details);
    });
}

function solve() {
    $.ajax({
        url: abspath("solve"),
        type: "POST",
        data: JSON.stringify({
            "graph": graph,
            "binding": $("button#dropdown_header").data("id"),
        }),
        contentType: "application/json",
        dataType: "json",
    }).done(function(data,status,jqxhr){
        var header = data["header"];
        var result = data["result"];
        var options = data["options"];
        var equalities = data["equalities"];

        var resultTable = $("<table>").attr("id","resultTable");
        var hrow = $("<tr>");
        $.each(header,function(index,colname) {
            $("<th>").text(colname.replace("t","#")).appendTo(hrow);
        });
        resultTable.append(hrow);
        $.each(result,function(i,tuple) {
            var row = $("<tr>");
            $.each(tuple,function(j,value) {
                $("<td>").text(value).appendTo(row);
            });
            resultTable.append(row);
        });
        $("#resultTable").replaceWith(resultTable)

        var optionsView = $("<div>").attr("id","optionsView");
        $.each(options,function(nodeId,nodeOpts) {
            var details = $("<details>").addClass("nodeContext").prop("open",true);
            var sort = graph.nodes[nodeId].sort
            $("<summary>").text(sort+" "+nodeId.replace("t","#")).appendTo(details);
            $.each(nodeOpts,function(prefix,scaleOpts) {
                var div = $("<div>").addClass("options");
                $("<span>").addClass("label")
                           .text(prefix+": ")
                           .appendTo(div);
                $.each(scaleOpts,function(index,entry) {
                    if(entry.hasOwnProperty("pos")) { // role attribute
                        $("<button>").addClass("role")
                                     .addClass("option")
                                     .addClass(entry["grp"])
                                     .text(entry["name"]+"["+entry["pos"]+"]")
                                     .attr("data-obj",nodeId)
                                     .attr("data-attr",prefix+":"+entry["name"])
                                     .attr("data-role",entry["pos"])
                                     .attr("data-sort",JSON.stringify(entry["sort"]))
                                     .on("click",create_rnode)
                                     .appendTo(div);
                    } else {
                        $("<button>").addClass("attribute")
                                     .addClass("option")
                                     .addClass(entry["grp"])
                                     .text(entry["name"])
                                     .attr("data-obj",nodeId)
                                     .attr("data-attr",prefix+":"+entry["name"])
                                     .on("click",toggle_attribute)
                                     .appendTo(div);
                    }
                });
                details.append(div);
            });
            optionsView.append(details);
        });

        var details = $("<details>").addClass("nodeContext").prop("open",true);
        $("<summary>").text("Equalities").appendTo(details);
        var div = $("<div>").addClass("options");
        $.each(equalities,function(index,eq) {
            $("<button>").addClass("equality")
                         .addClass("option")
                         .addClass(eq["grp"])
                         .attr("data-lhs",eq["lhs"])
                         .attr("data-rhs",eq["rhs"])
                         .text(eq["lhs"]+"="+eq["rhs"])
                         .on("click",toggle_coreference)
                         .appendTo(div);
        });
        details.append(div);
        optionsView.append(details);

        $("#optionsView").replaceWith(optionsView);
    });
}

function place_node(e) {
    if(queue.length > 0) {

        var $this = $(this);
        var $node = queue.shift();

        var x = e.pageX - $this.offset().left;
        var y = e.pageY - $this.offset().top;

        $node.resolve(x,y);
        graph.draw();

        if(queue.length == 0) {
            $('html').css('cursor','default');
            solve();
        }
    }
}

function set_content(e) {
    var $this = $(this);
    var page = $this.data("content");

    var html = $("template#"+page).html();
    $("main").replaceWith($(html));

    if(page === "page1") {
        edit_mode = false;
        get_scales();
        $(".js-create_scale").on("click",create_scale);
        $(".js-delete-scale").on("click",delete_scale);
        $(".js-create_attribute").on("click",create_attribute);
        $(".js-delete_attribute").on("click",delete_attribute);
    } else if(page === "page2") {
        edit_mode = false;
        get_bindings();
        get_scales_2();
        $(".js-create_binding").on("click",create_binding);
        $(".js-delete_binding").on("click",delete_binding);
    } else if(page === "page3") {
        queue = [];
        edit_mode = false;
        get_sorts();
        $("svg").on("click",place_node);
    }

    $("a.nav").removeClass("selected");
    $("#"+"ref_"+page).addClass("selected");
}

$(document).ready(function(){
    $.ajax({
        url: abspath("get_bindings"),
        dataType: "json",
    }).done(function(data,status,jqxhr) {
        var $dropdown_header = $("button#dropdown_header");
        var $dropdown_list = $("ul#dropdown_list");
        $dropdown_header.text("")
                        .data("id","");
        $dropdown_list.empty();
        $.each(data,function(index,row) {
            var id = row[0];
            var name = row[1];
            var host = row[2];
            var database = row[3];
            var li = $("<li>").attr("data-id",id)
                     .text(name)
                     .on("click",select_dropdown);
            $dropdown_list.append(li);

            if(index === 0) {
                $dropdown_header.html(name+" &#x25bc;")
                                .data("id",id);
            }
        });
        $("a.nav").on("click",set_content);
        $("#ref_page3").trigger("click");
    });
});

</script>
</head>
<body class="vbox" style="height:100vh;margin:0px;">
    <header style="display:flex;background:black;">
        <a id="ref_page1" class="nav" data-content="page1">Scales</a>
        <a id="ref_page2" class="nav" data-content="page2">Bindings</a>
        <a id="ref_page3" class="nav" data-content="page3">Navigation</a>
        <div style="flex-grow:1"></div>
        <div id="dropdown">
            <button id="dropdown_header"></button>
            <ul id="dropdown_list"></ul>
        </div>
        <div style="flex-basis:5%">
    </header>
    <template id="table_box">
        <div class="table_box" style="display:flex;flex-direction:column;padding:2px;">
            <div class="titlebar">
                <div style="flex-basis:20%;"></div>
                <div class="title"></div>
                <div style="flex-basis:20%;text-align:right;">
                    <button class="icon js-delete_binding_box">x</button>
                </div>
            </div>
            <div class="table_box_content">
                <table style="margin:5px;">
                    <thead>
                        <tr><th style="width:100px;">Parameter</th><th style="width:200px;">Column</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </template>
    <template id="page1">
        <main class="hbox" style="flex-grow:1;">
            <div class="window" style="flex-basis:50%;">
                <div class="titlebar">
                    <div style="flex-basis:20%;"></div>
                    <div class="title">Conceptual Scales</div>
                    <div style="flex-basis:20%;text-align:right;">
                        <button class="icon js-create_scale">&plus;</button>
                        <button class="icon js-delete-scale">&minus;</button>
                    </div>
                </div>
                <div class="content">
                    <table style="margin:5px;">
                        <thead>
                            <tr><th style="width:200px;">Name</th><th style="width:100px;">Arity</th></tr>
                        </thead>
                        <tbody id="scales"></tbody>
                    </table>
                </div>
            </div>
            <div class="window" style="flex-basis:50%;">
                <div class="titlebar">
                    <div style="flex-basis:20%;"></div>
                    <div class="title">Attributes</div>
                    <div style="flex-basis:20%;text-align:right;">
                        <button class="icon js-create_attribute">&plus;</button>
                        <button class="icon js-delete_attribute">&minus;</button>
                    </div>
                </div>
                <div class="content">
                    <table style="margin:5px;">
                        <thead>
                            <tr><th style="width:100px;">Attribute</th><th style="width:400px;">SQL Definition</th></tr>
                        </thead>
                        <tbody id="attributes"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </template>
    <template id="page2">
        <main class="hbox" style="flex-grow:1;">
            <div class="vbox" style="flex-basis:33%;">
                <div class="window" style="flex-basis:50%;">
                    <div class="titlebar">
                        <div style="flex-basis:20%;"></div>
                        <div class="title">Bindings</div>
                        <div style="flex-basis:20%;text-align:right;">
                            <button class="icon js-create_binding">&plus;</button>
                            <button class="icon js-delete_binding">&minus;</button>
                        </div>
                    </div>
                    <div class="content">
                        <table style="margin:5px;">
                            <thead>
                                <tr><th style="width:100px;">Host</th><th style="width:100px;">Database</th><th style="width:100px;">Binding</th></tr>
                            </thead>
                            <tbody id="bindings"></tbody>
                        </table>
                    </div>
                </div>
                <div class="window" style="flex-basis:50%;">
                    <div class="titlebar">
                        <div style="flex-basis:20%;"></div>
                        <div class="title">Conceptual Scales</div>
                        <div style="flex-basis:20%;text-align:right;"></div>
                    </div>
                    <div class="content">
                        <table style="margin:5px;">
                            <thead>
                                <tr><th style="width:200px;">Name</th><th style="width:100px;">Arity</th></tr>
                            </thead>
                            <tbody id="scales"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="window" style="flex-basis:34%;">
                <div class="titlebar">
                    <div style="flex-basis:20%;"></div>
                    <div class="title">Columns</div>
                    <div style="flex-basis:20%;text-align:right;"></div>
                </div>
                <div class="content">
                    <table style="margin:5px;">
                        <thead>
                            <tr><th style="width:200px;">Table</th><th style="width:200px;">Column</th></tr>
                        </thead>
                        <tbody id="columns"></tbody>
                    </table>
                </div>
            </div>
            <div class="window" style="flex-basis:33%;">
                <div class="titlebar">
                    <div style="flex-basis:20%;"></div>
                    <div class="title">Bound Scales</div>
                    <div style="flex-basis:20%;text-align:right;"></div>
                </div>
                <div id="bound_scales" class="content"></div>
            </div>
        </main>
    </template>
    <template id="page3">
        <main class="vbox" style="flex-grow:1;">
            <div class="hbox" style="flex-basis:50%;">
                <div class="window" style="flex-basis:25%;">
                    <div class="titlebar">
                        <div class="title">Options</div>
                    </div>
                    <div class="content">
                        <div id="sortsView"></div>
                        <div id="optionsView"></div>
                    </div>
                </div>
                <div class="window" style="flex-basis:75%;">
                    <div class="titlebar">
                        <div class="title">Graph</div>
                    </div>
                    <svg class="content" style="background:white;">
                        <g></g>
                    </svg>
                </div>
            </div>
            <div class="window" style="flex-basis:50%;">
                <div class="titlebar">
                    <div class="title">Result</div>
                </div>
                <div class="content">
                    <table id="resultTable"></table>
                <div>
            </div>
        </main>
    </template>
    <main style="flex-grow:1;">
    </main>
</body>
</html>
